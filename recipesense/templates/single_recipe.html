{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ recipe.title }} | RecipeSense</title>
    <link rel="stylesheet" href="{% static 'css/single_recipe.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    {% csrf_token %}

    <div class="overlay" onclick="closeModal(event)">
        <div class="recipe-modal">

            <!-- CLOSE BUTTON -->
            <button class="close-btn" onclick="goBack()">âœ•</button>

            <!-- HERO IMAGE -->
            <div class="hero">
                <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
                <div class="hero-overlay">
                    <div class="badges">
                        {% if recipe.glutenFree %}
                        <span class="badge">Gluten-Free</span>
                        {% endif %}
                        {% if recipe.dairyFree %}
                        <span class="badge">Dairy-Free</span>
                        {% endif %}
                        {% if recipe.vegetarian %}
                        <span class="badge">Vegetarian</span>
                        {% endif %}
                        {% if recipe.vegan %}
                        <span class="badge">Vegan</span>
                        {% endif %}
                    </div>
                    <h1>{{ recipe.title }}</h1>
                </div>
            </div>

            <!-- STATS -->
            <div class="stats">
                <div class="stat">
                    â±
                    <strong>{{ recipe.readyInMinutes }}</strong>
                    <span>Minutes</span>
                </div>
                <div class="stat">
                    ğŸ‘¥
                    <strong>{{ recipe.servings }}</strong>
                    <span>Servings</span>
                </div>
                <div class="stat">
                    ğŸ”¥
                    <strong>{{ recipe.nutrition.nutrients.0.amount|floatformat:0 }}</strong>
                    <span>Calories</span>
                </div>
                <div class="stat">
                    ğŸ’š
                    <strong>{{ recipe.healthScore }}</strong>
                    <span>Health Score</span>
                </div>
            </div>

            <!-- SAVE BUTTON -->
            <button class="save-btn" onclick="toggleFavorite(this)" data-id="{{ recipe.id }}"
                data-title="{{ recipe.title }}" data-image="{{ recipe.image }}" data-time="{{ recipe.readyInMinutes }}">
                <span class="heart">â™¡</span> Save to Favorites
            </button>

            <!-- TABS -->
            <div class="tabs">
                <button class="tab active" onclick="openTab('ingredients', this)">ğŸ›’ Ingredients</button>
                <button class="tab" onclick="openTab('instructions', this)">ğŸ‘¨â€ğŸ³ Instructions</button>
                <button class="tab" onclick="openTab('nutrition', this)">ğŸ”¥ Nutrition</button>
            </div>

            <!-- TAB CONTENT -->
            <div class="content">

                <!-- INGREDIENTS TAB -->
                <div id="ingredients" class="tab-content active">
                    {% for ing in recipe.extendedIngredients %}
                    <div class="ingredient">
                        <img src="https://spoonacular.com/cdn/ingredients_100x100/{{ ing.image }}" alt="{{ ing.name }}">
                        <span>{{ ing.original }}</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- INSTRUCTIONS TAB -->
                <div id="instructions" class="tab-content">
                    {{ recipe.instructions|safe }}
                </div>

                <!-- NUTRITION TAB -->
                <div id="nutrition" class="tab-content">
                    {% for n in recipe.nutrition.nutrients %}
                    <div class="nutrition-row">
                        <span>{{ n.name }}</span>
                        <strong>{{ n.amount }} {{ n.unit }}</strong>
                    </div>
                    {% endfor %}
                </div>
                <!-- 
        <div class="ai-helper">
          <h3>ğŸ¤– Ask AI about this recipe</h3>

          <form method="POST">
            {% csrf_token %}
            <input type="text" name="question" placeholder="Can I replace butter with oil?" required>
            <button type="submit">Ask</button>
          </form>

          {% if ai_reply %}
          <div class="ai-answer">{{ ai_reply }}</div>
          {% endif %}
        </div> -->

                {% if ai_answer %}
                <div class="ai-response">
                    <strong>ğŸ¤– Cooking Assistant:</strong>
                    <p>{{ ai_answer }}</p>
                </div>
                {% endif %}


            </div>

        </div>
    </div>

    <script>
        function openTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function closeModal(e) {
            if (e.target.classList.contains("overlay")) {
                goBack();
            }
        }

        function goBack() {
            window.location.href = "{% url 'app:recipe_detail' %}";
        }



        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function toggleFavorite(btn) {
            fetch("{% url 'app:toggle_favorite' recipe.id %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                    recipe_id: btn.dataset.id,
                    title: btn.dataset.title,
                    image: btn.dataset.image,
                    time: btn.dataset.time
                })
            })
                .then(res => res.json())
                .then(data => {
                    btn.classList.toggle("active");
                    btn.querySelector(".heart").textContent = data.status === "added" ? "â™¥" : "â™¡";
                })
                .catch(err => console.error(err));
        }
    </script>

</body>

</html>